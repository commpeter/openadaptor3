<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
  This adaptor does the following...
  
    * reads data from stdin
    * filters out data that = "discard"
    * writes data to stdout
  
  Filtered data is sent to discard.txt
  
  Run it like this...
  
  java org.openadaptor.spring.SpringApplication -config discard.xml -bean Adaptor
  
  You need the following in your classpath
  
    lib
    lib/openadaptor.jar
    lib/openadaptor-spring.jar
    lib/openadaptor-depends.jar
  
  Once it is running it will wait for command line input
  
  type something like this...
  
    foobar
  
  ...and you should see it echo-ed
  
  type in discard and it should be filtered out and sent discards.txt

-->

<beans>
  
  <bean id="Adaptor" class="org.openadaptor.core.adaptor.Adaptor">
    <property name="messageProcessor" ref="Router"/>
  </bean>
  
  <bean id="Router" class="org.openadaptor.core.router.Router">
    <property name="routingMap" ref="RoutingMap"/>
  </bean>
  
  <bean id="RoutingMap" class="org.openadaptor.core.router.RoutingMap">
    <property name="processMap">
      <map>
        <entry key-ref="Reader" value-ref="MapConverter"/>
        <entry key-ref="MapConverter" value-ref="Filter"/>
        <entry key-ref="Filter" value-ref="Writer"/>
      </map>
    </property>
    <!-- discard map -->
    <property name="discardMap">
      <map>
        <entry key-ref="Filter" value-ref="DiscardWriter"/>
      </map>
    </property>
  </bean>
  
  <bean id="Reader" class="org.openadaptor.auxil.connector.iostream.reader.StreamReadConnector">
    <property name="streamReader">
      <bean class="org.openadaptor.auxil.connector.iostream.reader.FileReader"/>
    </property>
    <property name="recordReader">
      <bean class="org.openadaptor.auxil.connector.iostream.reader.StringRecordReader"/>
    </property>
  </bean>
  
  <!-- converts intput into an ordered map with single field called data -->
  <bean id="MapConverter" class="org.openadaptor.auxil.convertor.delimited.DelimitedStringToOrderedMapConvertor">
    <property name="fieldNames">
      <list>
        <value>data</value>
      </list>
    </property>
  </bean>
  
  <!-- This processor discards data where data -->
  <bean id="Filter" class="org.openadaptor.auxil.processor.simplerecord.FilterProcessor">
    <property name="discardMatches" value="true"/>
    <property name="filterExpressionString" value="{data} = 'discard'"/>
  </bean>
  
  <bean id="Writer" class="org.openadaptor.core.adaptor.AdaptorOutpoint">
    <property name="connector">
      <bean class="org.openadaptor.auxil.connector.iostream.writer.StreamWriteConnector">
        <property name="streamWriter">
          <bean class="org.openadaptor.auxil.connector.iostream.writer.FileWriter"/>
        </property>
      </bean>
    </property>
    <property name="processor">
      <bean class="org.openadaptor.auxil.convertor.delimited.OrderedMapToDelimitedStringConvertor"/>
    </property>
  </bean>
  
  <bean id="DiscardWriter" class="org.openadaptor.core.adaptor.AdaptorOutpoint">
    <property name="connector">
      <bean class="org.openadaptor.auxil.connector.iostream.writer.StreamWriteConnector">
        <property name="streamWriter">
          <bean class="org.openadaptor.auxil.connector.iostream.writer.FileWriter">
            <property name="path" value="discards.txt"/>
            <property name="append" value="false"/>
          </bean>
        </property>
      </bean>
    </property>
    <property name="processor">
      <bean class="org.openadaptor.auxil.convertor.delimited.OrderedMapToDelimitedStringConvertor"/>
    </property>
  </bean>
  
</beans>