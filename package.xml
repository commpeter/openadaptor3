<?xml version="1.0" encoding="UTF-8"?>
<project name="openadaptor-package" default="zippedpackage">
  
  <import file="build.xml"/>
  
  <property name="dir.package" value="${basedir}/package"/>
  <property name="dir.package.lib" value="${dir.package}/lib"/>
  <property name="dir.package.example" value="${dir.package}/example"/>
  <property name="dir.package.sql" value="${dir.package}/sql"/>
  <property name="dir.package.doc" value="${dir.package}/doc"/>
  
  <path id="classpath.package.test">
    <pathelement path="${dir.package.lib}"/>
    <pathelement path="${dir.package.lib}/openadaptor.jar"/>
    <pathelement path="${dir.package.lib}/openadaptor-depends.jar"/>
    <pathelement path="${dir.package.lib}/openadaptor-spring.jar"/>
    <pathelement path="${dir.package.lib}/openadaptor-stub.jar"/>
    <pathelement path="${dir.package.lib}/3rdparty/mail.jar"/>
    <pathelement path="${dir.package.lib}/3rdparty/activation.jar"/>
    <pathelement path="${dir.test.classes}"/>
    <fileset dir="${dir.test.lib}" includes="**/*.jar,**/*.zip"/>
  </path>

  <target name="clean">
    <delete dir="${dir.package}"/>
  </target>
  
  <target name="zippedpackage" depends="package, test, zip" description="create zipped package"/>
  
  <target name="package" depends="clean, lib, sql, example, doc"/>
  
  <target name="zip">
    <zip destfile="openadaptor-${tag}-bin.zip">
      <zipfileset dir="${dir.package}" prefix="openadaptor-${tag}"/>
    </zip>
  </target>
  
  <target name="lib" depends="buildtools.taskdef">
    <mkdir dir="${dir.package}"/>
    <mkdir dir="${dir.package.lib}"/>
    <mkdir dir="${dir.package.lib}/3rdparty"/>
    <jar destfile="${dir.package.lib}/openadaptor.jar">
      <fileset dir="${dir.classes}"/>
    </jar>
    <jar destfile="${dir.package.lib}/openadaptor-stub.jar">
      <fileset dir="${dir.stub.classes}"/>
    </jar>
    <jar destfile="${dir.package.lib}/openadaptor-spring.jar">
      <fileset dir="${dir.spring.classes}"/>
    </jar>
    <jarcopy todir="${dir.package.lib}/3rdparty" versionProperties="${basedir}/jarversions.properties" version="${tag}" manifest="${basedir}/lib/MANIFEST.MF">
      <fileset dir="${dir.lib}">
        <include name="*.jar"/>
        <include name="*.zip"/>
      </fileset>
      <fileset dir="${dir.spring.lib}">
        <include name="*.jar"/>
        <include name="*.zip"/>
      </fileset>
    </jarcopy>
    <jarcopy todir="${dir.package.lib}/3rdparty" versionProperties="${basedir}/jarversions.properties" version="${tag}">
      <fileset dir="${dir.test.lib}">
        <include name="*.jar"/>
        <include name="*.zip"/>
      </fileset>
    </jarcopy>
    <property name="includes.unqualified" value="org/**,javax/**,com/**,META-INF/services/**,META-INF/spring*"/>
    <jar destfile="${dir.package.lib}/openadaptor-depends.jar" manifest="lib/MANIFEST.MF">
      <!-- ordered list of jars, only includes qualified resources -->
      <zipfileset src="${dir.lib}/XmlSchema.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/carol.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-codec.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-collections.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-httpclient.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-jxpath.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-lang.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-logging.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/commons-net.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/dom4j.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jaxen.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jaxrpc.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jdom.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jetty-util.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jetty.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jms.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jmxremote.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jmxri.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jmxtools.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jotm.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jotm_jrmp_stubs.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/js.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/json.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/jta-spec.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/log4j.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/qname.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/quartz.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/resolver.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/rome.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/saaj.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/serializer.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/servlet-api.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/stax-api.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/velocity.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/wsdl4j.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/wstx-asl.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/xercesImpl.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/xfire-all.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.lib}/xml-apis.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.spring.lib}/spring-core.jar" includes="${includes.unqualified}"/>
      <zipfileset src="${dir.spring.lib}/spring.jar" includes="${includes.unqualified}"/>
      <!-- ordered list of jars, includes non-qualified resources but with prefix -->
      <zipfileset src="${dir.lib}/XmlSchema.jar" excludes="${includes.unqualified}" prefix="XmlSchema"/>
      <zipfileset src="${dir.lib}/carol.jar" excludes="${includes.unqualified}" prefix="carol"/>
      <zipfileset src="${dir.lib}/commons-codec.jar" excludes="${includes.unqualified}" prefix="commons-codec"/>
      <zipfileset src="${dir.lib}/commons-collections.jar" excludes="${includes.unqualified}" prefix="commons-collections"/>
      <zipfileset src="${dir.lib}/commons-httpclient.jar" excludes="${includes.unqualified}" prefix="commons-httpclient"/>
      <zipfileset src="${dir.lib}/commons-jxpath.jar" excludes="${includes.unqualified}" prefix="commons-jxpath"/>
      <zipfileset src="${dir.lib}/commons-lang.jar" excludes="${includes.unqualified}" prefix="commons-lang"/>
      <zipfileset src="${dir.lib}/commons-logging.jar" excludes="${includes.unqualified}" prefix="commons-logging"/>
      <zipfileset src="${dir.lib}/commons-net.jar" excludes="${includes.unqualified}" prefix="commons-net"/>
      <zipfileset src="${dir.lib}/dom4j.jar" excludes="${includes.unqualified}" prefix="dom4j"/>
      <zipfileset src="${dir.lib}/jaxen.jar" excludes="${includes.unqualified}" prefix="jaxen"/>
      <zipfileset src="${dir.lib}/jaxrpc.jar" excludes="${includes.unqualified}" prefix="jaxrpc"/>
      <zipfileset src="${dir.lib}/jdom.jar" excludes="${includes.unqualified}" prefix="jdom"/>
      <zipfileset src="${dir.lib}/jetty-util.jar" excludes="${includes.unqualified}" prefix="jetty-util"/>
      <zipfileset src="${dir.lib}/jetty.jar" excludes="${includes.unqualified}" prefix="jetty"/>
      <zipfileset src="${dir.lib}/jms.jar" excludes="${includes.unqualified}" prefix="jms"/>
      <zipfileset src="${dir.lib}/jmxremote.jar" excludes="${includes.unqualified}" prefix="jmxremote"/>
      <zipfileset src="${dir.lib}/jmxri.jar" excludes="${includes.unqualified}" prefix="jmxri"/>
      <zipfileset src="${dir.lib}/jmxtools.jar" excludes="${includes.unqualified}" prefix="jmxtools"/>
      <zipfileset src="${dir.lib}/jotm.jar" excludes="${includes.unqualified}" prefix="jotm"/>
      <zipfileset src="${dir.lib}/jotm_jrmp_stubs.jar" excludes="${includes.unqualified}" prefix="jotm_jrmp_stubs"/>
      <zipfileset src="${dir.lib}/js.jar" excludes="${includes.unqualified}" prefix="js"/>
      <zipfileset src="${dir.lib}/json.jar" excludes="${includes.unqualified}" prefix="json"/>
      <zipfileset src="${dir.lib}/jta-spec.jar" excludes="${includes.unqualified}" prefix="jta-spec"/>
      <zipfileset src="${dir.lib}/log4j.jar" excludes="${includes.unqualified}" prefix="log4j"/>
      <zipfileset src="${dir.lib}/qname.jar" excludes="${includes.unqualified}" prefix="qname"/>
      <zipfileset src="${dir.lib}/quartz.jar" excludes="${includes.unqualified}" prefix="quartz"/>
      <zipfileset src="${dir.lib}/resolver.jar" excludes="${includes.unqualified}" prefix="resolver"/>
      <zipfileset src="${dir.lib}/rome.jar" excludes="${includes.unqualified}" prefix="rome"/>
      <zipfileset src="${dir.lib}/saaj.jar" excludes="${includes.unqualified}" prefix="saaj"/>
      <zipfileset src="${dir.lib}/serializer.jar" excludes="${includes.unqualified}" prefix="serializer"/>
      <zipfileset src="${dir.lib}/servlet-api.jar" excludes="${includes.unqualified}" prefix="servlet-api"/>
      <zipfileset src="${dir.lib}/stax-api.jar" excludes="${includes.unqualified}" prefix="stax-api"/>
      <zipfileset src="${dir.lib}/velocity.jar" excludes="${includes.unqualified}" prefix="velocity"/>
      <zipfileset src="${dir.lib}/wsdl4j.jar" excludes="${includes.unqualified}" prefix="wsdl4j"/>
      <zipfileset src="${dir.lib}/wstx-asl.jar" excludes="${includes.unqualified}" prefix="wstx-asl"/>
      <zipfileset src="${dir.lib}/xercesImpl.jar" excludes="${includes.unqualified}" prefix="xercesImpl"/>
      <zipfileset src="${dir.lib}/xfire-all.jar" excludes="${includes.unqualified}" prefix="xfire-all"/>
      <zipfileset src="${dir.lib}/xml-apis.jar" excludes="${includes.unqualified}" prefix="xml-apis"/>
      <zipfileset src="${dir.spring.lib}/spring-core.jar" excludes="${includes.unqualified}" prefix="spring-core"/>
      <zipfileset src="${dir.spring.lib}/spring.jar" excludes="${includes.unqualified}" prefix="spring"/>
    </jar>
    <copy todir="${dir.package.lib}">
      <fileset dir="${dir.lib}">
        <include name="log4j.properties"/>
      </fileset>
    </copy>
  </target>
  
  <target name="example">
    <copy todir="${dir.package.example}">
      <fileset dir="${dir.example}">
        <include name="readme.html"/>
        <include name="build.xml"/>
        <include name="readme*"/>
        <include name="spring/**"/>
        <include name="src/**"/>
        <include name="bin/**"/>
        <include name="tutorial/**"/>
        <include name="tools/**"/>
      </fileset>
    </copy>
    <copy todir="${dir.package.example}/tutorial" file="${dir.example}/log4j.properties"/>
  </target>
  
  <target name="sql">
    <copy todir="${dir.package.sql}">
      <fileset dir="${dir.sql}"/>
    </copy>
  </target>
  
  <target name="doc" depends="lib">
    <mkdir dir="${dir.package.doc}"/>
    <javadoc 
	    destdir="${dir.package.doc}"
	    classpath="${dir.package.lib}/openadaptor.jar:${dir.package.lib}/openadaptor-depends.jar:${dir.package.lib}/openadaptor-spring.jar:${dir.package.lib}/openadaptor-stub.jar:${dir.lib}/mail.jar:${dir.lib}/activation.jar"
	    doctitle="openadaptor ${tag}" 
	    verbose="false"
    	additionalparam="-quiet">
      <fileset dir="${dir.src}">
        <include name="**/*.java"/>
      </fileset>
      <fileset dir="${dir.spring.src}">
        <include name="**/*.java"/>
      </fileset>
    </javadoc>
  </target>

  <target name="test" description="checks spring config examples are valid">
    <ant target="test.all" inheritAll="false">
      <reference refid="classpath.package.test" torefid="classpath.test"/> 
    </ant>
    <ant target="example.springcheck" inheritAll="false">
      <reference refid="classpath.package.test" torefid="classpath.test"/> 
    </ant>
  </target>
  
</project>